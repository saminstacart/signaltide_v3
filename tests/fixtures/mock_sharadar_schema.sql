-- Mock Sharadar Schema for CI/Testing
-- Minimal subset of tables and columns needed for plumbing tests
-- Data: 3 tickers (AAPL, MSFT, GOOGL) with 2020 Q1 data

-- Clean slate
DROP TABLE IF EXISTS sharadar_prices;
DROP TABLE IF EXISTS sharadar_sf1;
DROP TABLE IF EXISTS sharadar_insiders;
DROP TABLE IF EXISTS sharadar_tickers;
DROP TABLE IF EXISTS dim_trading_calendar;
DROP TABLE IF EXISTS dim_universe_membership;

-- ============================================================================
-- dim_trading_calendar: Trading days, weekends, holidays
-- ============================================================================
CREATE TABLE dim_trading_calendar (
    calendar_date TEXT PRIMARY KEY,
    is_trading_day INTEGER NOT NULL,
    day_of_week INTEGER NOT NULL,
    holiday_name TEXT,
    market_close_type TEXT NOT NULL,
    next_trading_date TEXT,
    prev_trading_date TEXT
);

-- 2020 Q1 calendar (Jan-Mar) + some extra days for edge cases
INSERT INTO dim_trading_calendar VALUES
-- January 2020
('2020-01-01', 0, 2, 'New Year''s Day', 'closed', '2020-01-02', '2019-12-31'),
('2020-01-02', 1, 3, NULL, 'normal', '2020-01-03', '2019-12-31'),
('2020-01-03', 1, 4, NULL, 'normal', '2020-01-06', '2020-01-02'),
('2020-01-04', 0, 5, NULL, 'closed', '2020-01-06', '2020-01-03'),
('2020-01-05', 0, 6, NULL, 'closed', '2020-01-06', '2020-01-03'),
('2020-01-06', 1, 0, NULL, 'normal', '2020-01-07', '2020-01-03'),
('2020-01-07', 1, 1, NULL, 'normal', '2020-01-08', '2020-01-06'),
('2020-01-08', 1, 2, NULL, 'normal', '2020-01-09', '2020-01-07'),
('2020-01-09', 1, 3, NULL, 'normal', '2020-01-10', '2020-01-08'),
('2020-01-10', 1, 4, NULL, 'normal', '2020-01-13', '2020-01-09'),
('2020-01-11', 0, 5, NULL, 'closed', '2020-01-13', '2020-01-10'),
('2020-01-12', 0, 6, NULL, 'closed', '2020-01-13', '2020-01-10'),
('2020-01-13', 1, 0, NULL, 'normal', '2020-01-14', '2020-01-10'),
('2020-01-14', 1, 1, NULL, 'normal', '2020-01-15', '2020-01-13'),
('2020-01-15', 1, 2, NULL, 'normal', '2020-01-16', '2020-01-14'),
('2020-01-16', 1, 3, NULL, 'normal', '2020-01-17', '2020-01-15'),
('2020-01-17', 1, 4, NULL, 'normal', '2020-01-21', '2020-01-16'),
('2020-01-18', 0, 5, NULL, 'closed', '2020-01-21', '2020-01-17'),
('2020-01-19', 0, 6, NULL, 'closed', '2020-01-21', '2020-01-17'),
('2020-01-20', 0, 0, 'Martin Luther King Jr. Day', 'closed', '2020-01-21', '2020-01-17'),
('2020-01-21', 1, 1, NULL, 'normal', '2020-01-22', '2020-01-17'),
('2020-01-22', 1, 2, NULL, 'normal', '2020-01-23', '2020-01-21'),
('2020-01-23', 1, 3, NULL, 'normal', '2020-01-24', '2020-01-22'),
('2020-01-24', 1, 4, NULL, 'normal', '2020-01-27', '2020-01-23'),
('2020-01-25', 0, 5, NULL, 'closed', '2020-01-27', '2020-01-24'),
('2020-01-26', 0, 6, NULL, 'closed', '2020-01-27', '2020-01-24'),
('2020-01-27', 1, 0, NULL, 'normal', '2020-01-28', '2020-01-24'),
('2020-01-28', 1, 1, NULL, 'normal', '2020-01-29', '2020-01-27'),
('2020-01-29', 1, 2, NULL, 'normal', '2020-01-30', '2020-01-28'),
('2020-01-30', 1, 3, NULL, 'normal', '2020-01-31', '2020-01-29'),
('2020-01-31', 1, 4, NULL, 'normal', '2020-02-03', '2020-01-30'),

-- February 2020
('2020-02-01', 0, 5, NULL, 'closed', '2020-02-03', '2020-01-31'),
('2020-02-02', 0, 6, NULL, 'closed', '2020-02-03', '2020-01-31'),
('2020-02-03', 1, 0, NULL, 'normal', '2020-02-04', '2020-01-31'),
('2020-02-04', 1, 1, NULL, 'normal', '2020-02-05', '2020-02-03'),
('2020-02-05', 1, 2, NULL, 'normal', '2020-02-06', '2020-02-04'),
('2020-02-06', 1, 3, NULL, 'normal', '2020-02-07', '2020-02-05'),
('2020-02-07', 1, 4, NULL, 'normal', '2020-02-10', '2020-02-06'),
('2020-02-08', 0, 5, NULL, 'closed', '2020-02-10', '2020-02-07'),
('2020-02-09', 0, 6, NULL, 'closed', '2020-02-10', '2020-02-07'),
('2020-02-10', 1, 0, NULL, 'normal', '2020-02-11', '2020-02-07'),
('2020-02-11', 1, 1, NULL, 'normal', '2020-02-12', '2020-02-10'),
('2020-02-12', 1, 2, NULL, 'normal', '2020-02-13', '2020-02-11'),
('2020-02-13', 1, 3, NULL, 'normal', '2020-02-14', '2020-02-12'),
('2020-02-14', 1, 4, NULL, 'normal', '2020-02-18', '2020-02-13'),
('2020-02-15', 0, 5, NULL, 'closed', '2020-02-18', '2020-02-14'),
('2020-02-16', 0, 6, NULL, 'closed', '2020-02-18', '2020-02-14'),
('2020-02-17', 0, 0, 'Presidents'' Day', 'closed', '2020-02-18', '2020-02-14'),
('2020-02-18', 1, 1, NULL, 'normal', '2020-02-19', '2020-02-14'),
('2020-02-19', 1, 2, NULL, 'normal', '2020-02-20', '2020-02-18'),
('2020-02-20', 1, 3, NULL, 'normal', '2020-02-21', '2020-02-19'),
('2020-02-21', 1, 4, NULL, 'normal', '2020-02-24', '2020-02-20'),
('2020-02-22', 0, 5, NULL, 'closed', '2020-02-24', '2020-02-21'),
('2020-02-23', 0, 6, NULL, 'closed', '2020-02-24', '2020-02-21'),
('2020-02-24', 1, 0, NULL, 'normal', '2020-02-25', '2020-02-21'),
('2020-02-25', 1, 1, NULL, 'normal', '2020-02-26', '2020-02-24'),
('2020-02-26', 1, 2, NULL, 'normal', '2020-02-27', '2020-02-25'),
('2020-02-27', 1, 3, NULL, 'normal', '2020-02-28', '2020-02-26'),
('2020-02-28', 1, 4, NULL, 'normal', '2020-03-02', '2020-02-27'),
('2020-02-29', 0, 5, NULL, 'closed', '2020-03-02', '2020-02-28'),

-- March 2020
('2020-03-01', 0, 6, NULL, 'closed', '2020-03-02', '2020-02-28'),
('2020-03-02', 1, 0, NULL, 'normal', '2020-03-03', '2020-02-28'),
('2020-03-03', 1, 1, NULL, 'normal', '2020-03-04', '2020-03-02'),
('2020-03-04', 1, 2, NULL, 'normal', '2020-03-05', '2020-03-03'),
('2020-03-05', 1, 3, NULL, 'normal', '2020-03-06', '2020-03-04'),
('2020-03-06', 1, 4, NULL, 'normal', '2020-03-09', '2020-03-05'),
('2020-03-07', 0, 5, NULL, 'closed', '2020-03-09', '2020-03-06'),
('2020-03-08', 0, 6, NULL, 'closed', '2020-03-09', '2020-03-06'),
('2020-03-09', 1, 0, NULL, 'normal', '2020-03-10', '2020-03-06'),
('2020-03-10', 1, 1, NULL, 'normal', '2020-03-11', '2020-03-09'),
('2020-03-11', 1, 2, NULL, 'normal', '2020-03-12', '2020-03-10'),
('2020-03-12', 1, 3, NULL, 'normal', '2020-03-13', '2020-03-11'),
('2020-03-13', 1, 4, NULL, 'normal', '2020-03-16', '2020-03-12'),
('2020-03-14', 0, 5, NULL, 'closed', '2020-03-16', '2020-03-13'),
('2020-03-15', 0, 6, NULL, 'closed', '2020-03-16', '2020-03-13'),
('2020-03-16', 1, 0, NULL, 'normal', '2020-03-17', '2020-03-13'),
('2020-03-17', 1, 1, NULL, 'normal', '2020-03-18', '2020-03-16'),
('2020-03-18', 1, 2, NULL, 'normal', '2020-03-19', '2020-03-17'),
('2020-03-19', 1, 3, NULL, 'normal', '2020-03-20', '2020-03-18'),
('2020-03-20', 1, 4, NULL, 'normal', '2020-03-23', '2020-03-19'),
('2020-03-21', 0, 5, NULL, 'closed', '2020-03-23', '2020-03-20'),
('2020-03-22', 0, 6, NULL, 'closed', '2020-03-23', '2020-03-20'),
('2020-03-23', 1, 0, NULL, 'normal', '2020-03-24', '2020-03-20'),
('2020-03-24', 1, 1, NULL, 'normal', '2020-03-25', '2020-03-23'),
('2020-03-25', 1, 2, NULL, 'normal', '2020-03-26', '2020-03-24'),
('2020-03-26', 1, 3, NULL, 'normal', '2020-03-27', '2020-03-25'),
('2020-03-27', 1, 4, NULL, 'normal', '2020-03-30', '2020-03-26'),
('2020-03-28', 0, 5, NULL, 'closed', '2020-03-30', '2020-03-27'),
('2020-03-29', 0, 6, NULL, 'closed', '2020-03-30', '2020-03-27'),
('2020-03-30', 1, 0, NULL, 'normal', '2020-03-31', '2020-03-27'),
('2020-03-31', 1, 1, NULL, 'normal', '2020-04-01', '2020-03-30'),

-- Extend to mid-2024 for test_trading_calendar.py tests
('2024-06-14', 1, 4, NULL, 'normal', '2024-06-17', '2024-06-13'),
('2024-06-15', 0, 5, NULL, 'closed', '2024-06-17', '2024-06-14'),
('2024-06-16', 0, 6, NULL, 'closed', '2024-06-17', '2024-06-14'),
('2024-06-17', 1, 0, NULL, 'normal', '2024-06-18', '2024-06-14'),
('2024-06-18', 1, 1, NULL, 'normal', '2024-06-19', '2024-06-17'),
('2024-06-19', 0, 2, 'Juneteenth', 'closed', '2024-06-20', '2024-06-18'),
('2024-06-20', 1, 3, NULL, 'normal', '2024-06-21', '2024-06-18'),
-- July 4 2024 test
('2024-07-01', 1, 0, NULL, 'normal', '2024-07-02', '2024-06-28'),
('2024-07-02', 1, 1, NULL, 'normal', '2024-07-03', '2024-07-01'),
('2024-07-03', 1, 2, NULL, 'normal', '2024-07-05', '2024-07-02'),
('2024-07-04', 0, 3, 'Independence Day', 'closed', '2024-07-05', '2024-07-03'),
('2024-07-05', 1, 4, NULL, 'normal', '2024-07-08', '2024-07-03');

-- ============================================================================
-- sharadar_tickers: Ticker metadata
-- ============================================================================
CREATE TABLE sharadar_tickers (
    ticker TEXT PRIMARY KEY,
    name TEXT,
    exchange TEXT,
    category TEXT,
    sector TEXT,
    industry TEXT
);

INSERT INTO sharadar_tickers VALUES
('AAPL', 'Apple Inc.', 'NASDAQ', 'Domestic', 'Technology', 'Consumer Electronics'),
('MSFT', 'Microsoft Corporation', 'NASDAQ', 'Domestic', 'Technology', 'Software'),
('GOOGL', 'Alphabet Inc. Class A', 'NASDAQ', 'Domestic', 'Communication Services', 'Internet Content & Information');

-- ============================================================================
-- sharadar_prices: OHLCV price data
-- ============================================================================
CREATE TABLE sharadar_prices (
    ticker TEXT NOT NULL,
    date TEXT NOT NULL,
    open REAL,
    high REAL,
    low REAL,
    close REAL,
    volume INTEGER,
    closeadj REAL,
    lastupdated TEXT,
    PRIMARY KEY (ticker, date)
);

-- Sample price data (2020 Q1) - simplified prices
INSERT INTO sharadar_prices VALUES
-- AAPL
('AAPL', '2020-01-02', 300.0, 305.0, 299.0, 304.0, 1000000, 304.0, '2020-01-03'),
('AAPL', '2020-01-03', 304.0, 308.0, 302.0, 307.0, 1100000, 307.0, '2020-01-04'),
('AAPL', '2020-01-06', 307.0, 310.0, 305.0, 309.0, 1050000, 309.0, '2020-01-07'),
('AAPL', '2020-02-03', 310.0, 315.0, 308.0, 313.0, 1200000, 313.0, '2020-02-04'),
('AAPL', '2020-03-02', 290.0, 295.0, 285.0, 288.0, 1500000, 288.0, '2020-03-03'),
('AAPL', '2020-03-31', 280.0, 285.0, 278.0, 283.0, 1800000, 283.0, '2020-04-01'),

-- MSFT
('MSFT', '2020-01-02', 160.0, 162.0, 159.0, 161.0, 800000, 161.0, '2020-01-03'),
('MSFT', '2020-01-03', 161.0, 163.0, 160.0, 162.0, 850000, 162.0, '2020-01-04'),
('MSFT', '2020-01-06', 162.0, 165.0, 161.0, 164.0, 900000, 164.0, '2020-01-07'),
('MSFT', '2020-02-03', 165.0, 168.0, 164.0, 167.0, 950000, 167.0, '2020-02-04'),
('MSFT', '2020-03-02', 155.0, 158.0, 153.0, 156.0, 1100000, 156.0, '2020-03-03'),
('MSFT', '2020-03-31', 158.0, 160.0, 157.0, 159.0, 1000000, 159.0, '2020-04-01'),

-- GOOGL
('GOOGL', '2020-01-02', 1350.0, 1360.0, 1345.0, 1357.0, 600000, 1357.0, '2020-01-03'),
('GOOGL', '2020-01-03', 1357.0, 1365.0, 1352.0, 1362.0, 620000, 1362.0, '2020-01-04'),
('GOOGL', '2020-01-06', 1362.0, 1370.0, 1358.0, 1368.0, 650000, 1368.0, '2020-01-07'),
('GOOGL', '2020-02-03', 1370.0, 1380.0, 1365.0, 1375.0, 700000, 1375.0, '2020-02-04'),
('GOOGL', '2020-03-02', 1300.0, 1310.0, 1290.0, 1305.0, 900000, 1305.0, '2020-03-03'),
('GOOGL', '2020-03-31', 1310.0, 1320.0, 1305.0, 1315.0, 850000, 1315.0, '2020-04-01');

-- ============================================================================
-- sharadar_sf1: Fundamental data (simplified)
-- ============================================================================
CREATE TABLE sharadar_sf1 (
    ticker TEXT NOT NULL,
    dimension TEXT NOT NULL,
    calendardate TEXT NOT NULL,
    datekey TEXT NOT NULL,
    reportperiod TEXT,
    revenue REAL,
    netinc REAL,
    equity REAL,
    assets REAL,
    marketcap REAL,
    roe REAL,
    PRIMARY KEY (ticker, dimension, calendardate)
);

-- Quarterly fundamentals (ARQ)
INSERT INTO sharadar_sf1 VALUES
-- AAPL Q4 2019 (filed early 2020)
('AAPL', 'ARQ', '2019-12-31', '2020-01-28', '2019-12-31', 91819000000, 22236000000, 90488000000, 338516000000, 1300000000000, 0.55),
-- MSFT Q4 2019
('MSFT', 'ARQ', '2019-12-31', '2020-01-30', '2019-12-31', 36906000000, 11649000000, 102330000000, 286556000000, 1200000000000, 0.42),
-- GOOGL Q4 2019
('GOOGL', 'ARQ', '2019-12-31', '2020-02-03', '2019-12-31', 46075000000, 10671000000, 201442000000, 319616000000, 900000000000, 0.18);

-- ============================================================================
-- sharadar_insiders: Insider trading data (minimal)
-- ============================================================================
CREATE TABLE sharadar_insiders (
    ticker TEXT NOT NULL,
    filingdate TEXT NOT NULL,
    transactiondate TEXT,
    transactioncode TEXT,
    transactionshares REAL,
    transactionprice REAL
);

-- Sample insider trades
INSERT INTO sharadar_insiders VALUES
('AAPL', '2020-01-15', '2020-01-13', 'P', 1000, 302.5),
('AAPL', '2020-02-20', '2020-02-18', 'S', -5000, 312.0),
('MSFT', '2020-01-20', '2020-01-17', 'P', 2000, 163.0),
('GOOGL', '2020-03-10', '2020-03-08', 'S', -1000, 1300.0);

-- ============================================================================
-- dim_universe_membership: Universe tracking (optional for advanced tests)
-- ============================================================================
CREATE TABLE dim_universe_membership (
    universe_name TEXT NOT NULL,
    ticker TEXT NOT NULL,
    start_date TEXT NOT NULL,
    end_date TEXT,
    market_cap REAL,
    PRIMARY KEY (universe_name, ticker, start_date)
);

-- Sample universe memberships
INSERT INTO dim_universe_membership VALUES
('sp500_proxy', 'AAPL', '2020-01-01', NULL, 1300000000000),
('sp500_proxy', 'MSFT', '2020-01-01', NULL, 1200000000000),
('sp500_proxy', 'GOOGL', '2020-01-01', NULL, 900000000000),
('top_50', 'AAPL', '2020-01-01', NULL, 1300000000000),
('top_50', 'MSFT', '2020-01-01', NULL, 1200000000000),
('top_50', 'GOOGL', '2020-01-01', NULL, 900000000000);
